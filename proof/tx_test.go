package proof

import (
	"bytes"
	"encoding/hex"
	"testing"

	"github.com/btcsuite/btcd/chaincfg"
	"github.com/btcsuite/btcd/wire"
	"github.com/stretchr/testify/require"
)

const (
	// Block 100002 with 9 transactions on bitcoin mainnet.
	oddTxBlockHex = "0100000090f0a9f110702f808219ebea1173056042a714bad51b916cb6800000000000005275289558f51c9966699404ae2294730c3c9f9bda53523ce50e9b95e558da2fdb261b4d4c86041b1ab1bf930901000000010000000000000000000000000000000000000000000000000000000000000000ffffffff07044c86041b0146ffffffff0100f2052a01000000434104e18f7afbe4721580e81e8414fc8c24d7cfacf254bb5c7b949450c3e997c2dc1242487a8169507b631eb3771f2b425483fb13102c4eb5d858eef260fe70fbfae0ac00000000010000000196608ccbafa16abada902780da4dc35dafd7af05fa0da08cf833575f8cf9e836000000004a493046022100dab24889213caf43ae6adc41cf1c9396c08240c199f5225acf45416330fd7dbd022100fe37900e0644bf574493a07fc5edba06dbc07c311b947520c2d514bc5725dcb401ffffffff0100f2052a010000001976a914f15d1921f52e4007b146dfa60f369ed2fc393ce288ac000000000100000001fb766c1288458c2bafcfec81e48b24d98ec706de6b8af7c4e3c29419bfacb56d000000008c493046022100f268ba165ce0ad2e6d93f089cfcd3785de5c963bb5ea6b8c1b23f1ce3e517b9f022100da7c0f21adc6c401887f2bfd1922f11d76159cbc597fbd756a23dcbb00f4d7290141042b4e8625a96127826915a5b109852636ad0da753c9e1d5606a50480cd0c40f1f8b8d898235e571fe9357d9ec842bc4bba1827daaf4de06d71844d0057707966affffffff0280969800000000001976a9146963907531db72d0ed1a0cfb471ccb63923446f388ac80d6e34c000000001976a914f0688ba1c0d1ce182c7af6741e02658c7d4dfcd388ac000000000100000002c40297f730dd7b5a99567eb8d27b78758f607507c52292d02d4031895b52f2ff010000008b483045022100f7edfd4b0aac404e5bab4fd3889e0c6c41aa8d0e6fa122316f68eddd0a65013902205b09cc8b2d56e1cd1f7f2fafd60a129ed94504c4ac7bdc67b56fe67512658b3e014104732012cb962afa90d31b25d8fb0e32c94e513ab7a17805c14ca4c3423e18b4fb5d0e676841733cb83abaf975845c9f6f2a8097b7d04f4908b18368d6fc2d68ecffffffffca5065ff9617cbcba45eb23726df6498a9b9cafed4f54cbab9d227b0035ddefb000000008a473044022068010362a13c7f9919fa832b2dee4e788f61f6f5d344a7c2a0da6ae740605658022006d1af525b9a14a35c003b78b72bd59738cd676f845d1ff3fc25049e01003614014104732012cb962afa90d31b25d8fb0e32c94e513ab7a17805c14ca4c3423e18b4fb5d0e676841733cb83abaf975845c9f6f2a8097b7d04f4908b18368d6fc2d68ecffffffff01001ec4110200000043410469ab4181eceb28985b9b4e895c13fa5e68d85761b7eee311db5addef76fa8621865134a221bd01f28ec9999ee3e021e60766e9d1f3458c115fb28650605f11c9ac000000000100000001cdaf2f758e91c514655e2dc50633d1e4c84989f8aa90a0dbc883f0d23ed5c2fa010000008b48304502207ab51be6f12a1962ba0aaaf24a20e0b69b27a94fac5adf45aa7d2d18ffd9236102210086ae728b370e5329eead9accd880d0cb070aea0c96255fae6c4f1ddcce1fd56e014104462e76fd4067b3a0aa42070082dcb0bf2f388b6495cf33d789904f07d0f55c40fbd4b82963c69b3dc31895d0c772c812b1d5fbcade15312ef1c0e8ebbb12dcd4ffffffff02404b4c00000000001976a9142b6ba7c9d796b75eef7942fc9288edd37c32f5c388ac002d3101000000001976a9141befba0cdc1ad56529371864d9f6cb042faa06b588ac000000000100000001b4a47603e71b61bc3326efd90111bf02d2f549b067f4c4a8fa183b57a0f800cb010000008a4730440220177c37f9a505c3f1a1f0ce2da777c339bd8339ffa02c7cb41f0a5804f473c9230220585b25a2ee80eb59292e52b987dad92acb0c64eced92ed9ee105ad153cdb12d001410443bd44f683467e549dae7d20d1d79cbdb6df985c6e9c029c8d0c6cb46cc1a4d3cf7923c5021b27f7a0b562ada113bc85d5fda5a1b41e87fe6e8802817cf69996ffffffff0280651406000000001976a9145505614859643ab7b547cd7f1f5e7e2a12322d3788ac00aa0271000000001976a914ea4720a7a52fc166c55ff2298e07baf70ae67e1b88ac00000000010000000586c62cd602d219bb60edb14a3e204de0705176f9022fe49a538054fb14abb49e010000008c493046022100f2bc2aba2534becbdf062eb993853a42bbbc282083d0daf9b4b585bd401aa8c9022100b1d7fd7ee0b95600db8535bbf331b19eed8d961f7a8e54159c53675d5f69df8c014104462e76fd4067b3a0aa42070082dcb0bf2f388b6495cf33d789904f07d0f55c40fbd4b82963c69b3dc31895d0c772c812b1d5fbcade15312ef1c0e8ebbb12dcd4ffffffff03ad0e58ccdac3df9dc28a218bcf6f1997b0a93306faaa4b3a28ae83447b2179010000008b483045022100be12b2937179da88599e27bb31c3525097a07cdb52422d165b3ca2f2020ffcf702200971b51f853a53d644ebae9ec8f3512e442b1bcb6c315a5b491d119d10624c83014104462e76fd4067b3a0aa42070082dcb0bf2f388b6495cf33d789904f07d0f55c40fbd4b82963c69b3dc31895d0c772c812b1d5fbcade15312ef1c0e8ebbb12dcd4ffffffff2acfcab629bbc8685792603762c921580030ba144af553d271716a95089e107b010000008b483045022100fa579a840ac258871365dd48cd7552f96c8eea69bd00d84f05b283a0dab311e102207e3c0ee9234814cfbb1b659b83671618f45abc1326b9edcc77d552a4f2a805c0014104462e76fd4067b3a0aa42070082dcb0bf2f388b6495cf33d789904f07d0f55c40fbd4b82963c69b3dc31895d0c772c812b1d5fbcade15312ef1c0e8ebbb12dcd4ffffffffdcdc6023bbc9944a658ddc588e61eacb737ddf0a3cd24f113b5a8634c517fcd2000000008b4830450221008d6df731df5d32267954bd7d2dda2302b74c6c2a6aa5c0ca64ecbabc1af03c75022010e55c571d65da7701ae2da1956c442df81bbf076cdbac25133f99d98a9ed34c014104462e76fd4067b3a0aa42070082dcb0bf2f388b6495cf33d789904f07d0f55c40fbd4b82963c69b3dc31895d0c772c812b1d5fbcade15312ef1c0e8ebbb12dcd4ffffffffe15557cd5ce258f479dfd6dc6514edf6d7ed5b21fcfa4a038fd69f06b83ac76e010000008b483045022023b3e0ab071eb11de2eb1cc3a67261b866f86bf6867d4558165f7c8c8aca2d86022100dc6e1f53a91de3efe8f63512850811f26284b62f850c70ca73ed5de8771fb451014104462e76fd4067b3a0aa42070082dcb0bf2f388b6495cf33d789904f07d0f55c40fbd4b82963c69b3dc31895d0c772c812b1d5fbcade15312ef1c0e8ebbb12dcd4ffffffff01404b4c00000000001976a9142b6ba7c9d796b75eef7942fc9288edd37c32f5c388ac00000000010000000166d7577163c932b4f9690ca6a80b6e4eb001f0a2fa9023df5595602aae96ed8d000000008a4730440220262b42546302dfb654a229cefc86432b89628ff259dc87edd1154535b16a67e102207b4634c020a97c3e7bbd0d4d19da6aa2269ad9dded4026e896b213d73ca4b63f014104979b82d02226b3a4597523845754d44f13639e3bf2df5e82c6aab2bdc79687368b01b1ab8b19875ae3c90d661a3d0a33161dab29934edeb36aa01976be3baf8affffffff02404b4c00000000001976a9144854e695a02af0aeacb823ccbc272134561e0a1688ac40420f00000000001976a914abee93376d6b37b5c2940655a6fcaf1c8e74237988ac0000000001000000014e3f8ef2e91349a9059cb4f01e54ab2597c1387161d3da89919f7ea6acdbb371010000008c49304602210081f3183471a5ca22307c0800226f3ef9c353069e0773ac76bb580654d56aa523022100d4c56465bdc069060846f4fbf2f6b20520b2a80b08b168b31e66ddb9c694e240014104976c79848e18251612f8940875b2b08d06e6dc73b9840e8860c066b7e87432c477e9a59a453e71e6d76d5fe34058b800a098fc1740ce3012e8fc8a00c96af966ffffffff02c0e1e400000000001976a9144134e75a6fcb6042034aab5e18570cf1f844f54788ac404b4c00000000001976a9142b6ba7c9d796b75eef7942fc9288edd37c32f5c388ac00000000"

	// Block 100003 with 12 transactions on bitcoin mainnet.
	evenTxBlockHex = "01000000aff7e0c7dc29d227480c2aa79521419640a161023b51cdb28a3b0100000000003779fc09d638c4c6da0840c41fa625a90b72b125015fd0273f706d61f3be175faa271b4d4c86041b142dca820c01000000010000000000000000000000000000000000000000000000000000000000000000ffffffff07044c86041b0105ffffffff0100f2052a01000000434104354eab02700b9adfae0e1254241a5d50c910c7c43388a91d135049d61608d57b27766ea3e2e00bf33f42e0c866d468d72d70c25a8f458d224a9cfa98f4c61640ac000000000100000001e0c28dbf9f266a8997e1a02ef44af3a1ee48202253d86161d71282d01e5e30fe010000008b48304502200ce17394660867b7c90f89d995b1433fe574822775c0d92ac26098faf401b571022100e76cf491ec73c6ef748bc29cdd0e595fa7d1bfe014fd9306305f27650bcb19b2014104ea10914b4fef0914d6afcf334f16f215660e3cac5a97624d6a32b4b97021d73330e003b1dc6fbaa86b4f493caccbb6dc6f7c695ece852e8abf2820afba008f6dffffffff02c0320a03000000001976a9146168f1368ef3e45fd53166199499020a4b9bf91f88ac4077f86d000000001976a91478e32fd3928cfa1cfbe43595311a973292c6accc88ac000000000100000001201f4587ec86b58297edc2dd32d6fcd998aa794308aac802a8af3be0e081d674000000008b48304502203506c7af67bd72847030faf8a9f9e7c0012f127415f94ee7b87f72fef7a43dbc022100b28ad13e561a3bab5b3f6b9301d00ae77a662dba550101fa14cd3420246e63c40141049112bfbe88ce0b3d0813f18e3cc6078f6211166298dc4c65fd0fb1303a9431df137617a6f7bde8411746f08d88ac2dc5ba9303caea948a531667bad075b97c99ffffffff02404b4c00000000001976a9142b6ba7c9d796b75eef7942fc9288edd37c32f5c388ac80969800000000001976a9149d871517162804ec48595ac97a3f6e3af719548e88ac0000000001000000015310aedf9c8068f1e862ac9186724f7fdedb0aa9819833af4f4016fca6d21fdd000000008b483045022100f1f64f345f30c3f0323de5f2ac288f83185253769a8f65a918caec7047f4504d02207a0182d0b8bbfac9542df4787b0d96da091780df96fed2a776c5a01e77df63ce0141041ba340ee313ae241b8221c97c46b9adef9f2f0e8a4a861011f1fccb8b62f2b1cfbe98df09176cc00f64f96a15bdb247bdd8bc4b27060948c5a60fd0b92e4085effffffff0240420f00000000001976a914dfb5bd621d66e957cd642bc8d65b5fd318a350ec88ac00093d00000000001976a914e2f2c2f37cbddbc64cbf6f1f028c2c8a7739010f88ac000000000100000001c27e2776254a0acdc9c18bfd2666a3857183c032ba058cdc7be22b44adf59699010000008b483045022100a594f3a88125883569d5d69176d754e845bba058a92e87c8daf7131a1b34fc3c02202b50bce7e68c78713eb214dd05847a0742740ac330c5cfe9e688af8d3a6b2cf7014104ddc05b55d9d3acca503d2aebc4519141ef38ebea8f7b950b3142db71b87a256d44cc18738d436ad6792a44676a6181c2ea390a21be30b35b60d04b5a26840565ffffffff02c086fd6a000000001976a9142b5cc97c3f95dc20beae095a6fe2274c3948570588ac80f0fa02000000001976a91456f000ac3ee604a7c2dabd4e82f16d363dcd298288ac000000000100000001758713310361270b5ec4cae9b0196cb84fdb2f174d29f9367ad341963fa83e56010000008b483045022100d7b8759aeffe9d829a5df062420eb25017d7341244e49cfede16136a0c0b8dd2022031b42048e66b1f82f7fa99a22954e2709269838ef587c20118e493ced0d63e21014104b9251638d1475b9c62e1cf03129c835bcd5ab843aa0016412e8b39e3f8f7188d3b59023bce2002a2e409ea070c7070392b65d9ae8c8631ae2672a8fbb4f62bbdffffffff02404b4c00000000001976a9143675767783fdf1922f57ab4bb783f3a88dfa609488ac404b4c00000000001976a9142b6ba7c9d796b75eef7942fc9288edd37c32f5c388ac00000000010000000123ef5b8dc3656f80d3716299a56be91d75c9bb754b675bd1b127ecde53b743b6000000008b48304502207e99923bd10fa2017c5f439c60695986ec442af1c52a3310b22e68b4ee6779e4022100aa84b7321424541075c05a0244a9973967ff07752c0cebe4ca2a9bdf0ecfe17c014104ca088e0d674c67404c16a7d49ea59b467f09daf16dfab1baeac6bbcd2f2674ad670da0e01a12cdbff4e91d46b5994d583e476910d8db15e84bb9a77460164e5effffffff0240a5ae02000000001976a914b55dd29fed068ccc1bc17312559953f6583ee7e488ac80e14e68000000001976a91444bce51126d64d006104a26f44f1597e4937452588ac0000000001000000012376bfcaa5bc0c3864c0ab20f2f1a2301f8d5408be2924721740681802f81a97000000008b4830450220377c24b01eb0e1cb51fff57b8ae814f43b03429ad70be3b871e8120f17079250022100e34787dc7fab91d9802ade84847c7b1308b5cc2ff8e827328f3271ba49b219480141043cb62688ba96924898f96f9a27328364ab4109407ab47522b1203d7b10364785e4901d6bdf5ec0b0ba4c56deaba832a93e74251176812c1038965628bf017fa2ffffffff01404b4c00000000001976a9142b6ba7c9d796b75eef7942fc9288edd37c32f5c388ac00000000010000000190ac85c88338b5ee4700b4131d17872a0b26806f123ceae83ec6d46a90b209fe010000008a4730440220767e105c213d3d823a5fed7ec85274770dfda68945d9e346e3d1460c2a9d715e02207d46d23c051531e30d8414951190d43e5af46cfb0a769dc119aacd13a8e33ec50141043d82b7876393cf7f46a1b63f911f38c09b3cf1c8edcf0385ce2b70ce52f0356c44c713493cfeff1042aa1bfce67540e76d76c83769b92c8ab6bf5c345562ac85ffffffff0280b41d67000000001976a914192beb072189022800ecc07211938f7948683c1688ac002d3101000000001976a91494325f0965dcd1c23b3b9f7ef6e93ae4d1a7c02b88ac00000000010000000127e706a02efbc6aff715083d3e26bf1197458e791cdfb29fc07309a5cc74a5d9000000008c493046022100b16337778e99a658ee7355e9d32d7eeb090ed6b7decb6041e8ae60bc1765bda4022100afe1ac3a0c8d60abf7dac9101ea94c804d7860899f5561a40a9335a6927fc6e10141048333f4c6691ae094c741d13f34303ac65c5ce09833ea5e614886ce3b267e713fe8f941e8da29fe746233554f94c18f734404f3e941d0bef02da3beaeb9a8a535ffffffff02c0ea2101000000001976a914417d48fe8e9bb1971c4a0e21c387a41ae200630488acc0c9fb65000000001976a9147e19933a6a86b7f7fe4a4facf5d23d2127d55a5488ac0000000001000000017b00c49d3193b1f565057420f57a1bf41c5396799081980c4e9784cf3b4823d5010000008c493046022100c0f8dc4111c7def22bd1cd5e5b16a63b9f03e4d64d6e24a986c765930e2680e2022100e30b50365f01cd6d4df11c8a530fba52f40acd6ad8fc5436cc836291df8d38b80141047101cf453ed5ae5e3863588a5c8f65ee633bf610c0e73100decf145f4a1586d64d4f6599c9fa563b059fe43cd3b34154de9fbdcd8d4cb189a38ce6493bce043bffffffff024021e964000000001976a914ff75b16b44247550e51d7d4ed7e80e23acfdca1188ac80a81201000000001976a914605e62db0e9dcc421f1b5936f5b7c4dfff7a748288ac0000000001000000018cc7bbcc435470f3f767348210b707cb887cb3fc46c2dd16207738db1c72e722000000008a473044022024354d328e6a84717e6ff71c5d39ffaf21bb2ba3278acabbb793ed90cad1fa7a02204e36ba837fd0c49fbd4e1045bb18a4556bb7fa0757a5651de40a64798227e52e0141040419507a674c45c65b76192cac56c409ac6c4fe4b8f292470d10b689bfb0df34d40037023507dce82ba51daf7c60c71d4100fe83602428f0bf516ed22c01a224ffffffff02809fd500000000001976a914d5dc1f4d24658896095b777b4f57d9eaab3d1bbe88acc0811364000000001976a91411106981411de25053a8182ae4a26365d33950a888ac00000000"
)

var (
	oddTxBlock, evenTxBlock wire.MsgBlock
)

func init() {
	oddTxBlockBytes, err := hex.DecodeString(oddTxBlockHex)
	if err != nil {
		panic(err)
	}
	err = oddTxBlock.Deserialize(bytes.NewReader(oddTxBlockBytes))
	if err != nil {
		panic(err)
	}

	evenTxBlockBytes, err := hex.DecodeString(evenTxBlockHex)
	if err != nil {
		panic(err)
	}
	err = evenTxBlock.Deserialize(bytes.NewReader(evenTxBlockBytes))
	if err != nil {
		panic(err)
	}
}

func TestTxMerkleProof(t *testing.T) {
	t.Parallel()

	blocks := []wire.MsgBlock{
		*chaincfg.MainNetParams.GenesisBlock, // 1 transaction
		oddTxBlock,                           // 9 transactions
		evenTxBlock,                          // 12 transactions
	}
	for _, block := range blocks {
		for i, tx := range block.Transactions {
			proof, err := NewTxMerkleProof(block.Transactions, i)
			require.NoError(t, err)
			require.True(t, proof.Verify(tx, block.Header.MerkleRoot))

			var buf bytes.Buffer
			require.NoError(t, proof.Encode(&buf))
			var decoded TxMerkleProof
			require.NoError(t, decoded.Decode(&buf))
			require.Equal(t, *proof, decoded)
			require.True(t, decoded.Verify(tx, block.Header.MerkleRoot))
		}
	}
}
